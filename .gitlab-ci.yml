---

stages:
  - base
  - variant
  - push
  - clean

## Run base image builds
base-latest:
  stage: base
  retry: 2
  only:
    - master
  before_script:
    - docker info
  script:
    - docker build --pull -t "ubuntu/latest/base" "./latest/base/"
    - docker tag "ubuntu/latest/base" "${CI_REGISTRY_IMAGE}:latest"
    - docker tag "ubuntu/latest/base" "${GITLAB_CI_REGISTRY}:latest"
base-eoan:
  stage: base
  retry: 2
  only:
    - master
  before_script:
    - docker info
  script:
    - docker build --pull -t "ubuntu/eoan/base" "./eoan/base/"
    - docker tag "ubuntu/eoan/base" "${CI_REGISTRY_IMAGE}/eoan:latest"
    - docker tag "ubuntu/eoan/base" "${GITLAB_CI_REGISTRY}/eoan:latest"
base-focal:
  stage: base
  retry: 2
  only:
    - master
  before_script:
    - docker info
  script:
    - docker build --pull -t "ubuntu/focal/base" "./focal/base/"
    - docker tag "ubuntu/focal/base" "${CI_REGISTRY_IMAGE}/focal:latest"
    - docker tag "ubuntu/focal/base" "${GITLAB_CI_REGISTRY}/focal:latest"

## Build the variant images
### Latest
variant-latest-supvervisor:
  stage: variant
  retry: 2
  only:
    - master
  before_script:
    - docker info
  script:
    - docker build -t "ubuntu/latest/supverisor" "./latest/supvervisor/"
    - docker tag "ubuntu/latest/supverisor" "${CI_REGISTRY_IMAGE}/latest:supervisor"
    - docker tag "ubuntu/latest/supverisor" "${GITLAB_CI_REGISTRY}/latest:supervisor"
variant-latest-vscode:
  stage: variant
  retry: 2
  only:
    - master
  before_script:
    - docker info
  script:
    - docker build -t "ubuntu/latest/vscode" "./latest/vscode/"
    - docker tag "ubuntu/latest/vscode" "${CI_REGISTRY_IMAGE}/latest:vscode"
    - docker tag "ubuntu/latest/vscode" "${GITLAB_CI_REGISTRY}/latest:vscode"
### Eoan
variant-eoan-supvervisor:
  stage: variant
  retry: 2
  only:
    - master
  before_script:
    - docker info
  script:
    - docker build -t "ubuntu/eoan/supverisor" "./eoan/supvervisor/"
    - docker tag "ubuntu/eoan/supverisor" "${CI_REGISTRY_IMAGE}/eoan:supervisor"
    - docker tag "ubuntu/eoan/supverisor" "${GITLAB_CI_REGISTRY}/eoan:supervisor"
variant-eoan-vscode:
  stage: variant
  retry: 2
  only:
    - master
  before_script:
    - docker info
  script:
    - docker build -t "ubuntu/eoan/vscode" "./eoan/vscode/"
    - docker tag "ubuntu/eoan/vscode" "${CI_REGISTRY_IMAGE}/eoan:vscode"
    - docker tag "ubuntu/eoan/vscode" "${GITLAB_CI_REGISTRY}/eoan:vscode"
### Focal
variant-focal-supvervisor:
  stage: variant
  retry: 2
  only:
    - master
  before_script:
    - docker info
  script:
    - docker build -t "ubuntu/focal/supverisor" "./focal/supvervisor/"
    - docker tag "ubuntu/focal/supverisor" "${CI_REGISTRY_IMAGE}/focal:supervisor"
    - docker tag "ubuntu/focal/supverisor" "${GITLAB_CI_REGISTRY}/focal:supervisor"
variant-focal-vscode:
  stage: variant
  retry: 2
  only:
    - master
  before_script:
    - docker info
  script:
    - docker build -t "ubuntu/focal/vscode" "./focal/vscode/"
    - docker tag "ubuntu/focal/vscode" "${CI_REGISTRY_IMAGE}/focal:vscode"
    - docker tag "ubuntu/focal/vscode" "${GITLAB_CI_REGISTRY}/focal:vscode"

## Push all images
### Latest
push-latest-remotesx:
  stage: push
  retry: 2
  only:
    - master
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_JOB_TOKEN $CI_REGISTRY
  script:
    - docker push "${CI_REGISTRY_IMAGE}:latest"
    - docker push "${CI_REGISTRY_IMAGE}/latest:supervisor"
    - docker push "${CI_REGISTRY_IMAGE}/latest:vscode"
push-latest-gitlab:
  stage: push
  retry: 2
  only:
    - master
  before_script:
    - docker login -u $GITLAB_CI_USER -p $GITLAB_CI_TOKEN $GITLAB_CI_REGISTRY
  script:
    - docker push "${GITLAB_CI_REGISTRY}:latest"
    - docker push "${GITLAB_CI_REGISTRY}/latest:supervisor"
    - docker push "${GITLAB_CI_REGISTRY}/latest:vscode"
### Eoan
push-eoan-remotesx:
  stage: push
  retry: 2
  only:
    - master
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_JOB_TOKEN $CI_REGISTRY
  script:
    - docker push "${CI_REGISTRY_IMAGE}/eoan:latest"
    - docker push "${CI_REGISTRY_IMAGE}/eoan:supervisor"
    - docker push "${CI_REGISTRY_IMAGE}/eoan:vscode"
push-eoan-gitlab:
  stage: push
  retry: 2
  only:
    - master
  before_script:
    - docker login -u $GITLAB_CI_USER -p $GITLAB_CI_TOKEN $GITLAB_CI_REGISTRY
  script:
    - docker push "${GITLAB_CI_REGISTRY}/eoan:latest"
    - docker push "${GITLAB_CI_REGISTRY}/eoan:supervisor"
    - docker push "${GITLAB_CI_REGISTRY}/eoan:vscode"
### Focal
push-focal-remotesx:
  stage: push
  retry: 2
  only:
    - master
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_JOB_TOKEN $CI_REGISTRY
  script:
    - docker push "${CI_REGISTRY_IMAGE}/focal:latest"
    - docker push "${CI_REGISTRY_IMAGE}/focal:supervisor"
    - docker push "${CI_REGISTRY_IMAGE}/focal:vscode"
push-focal-gitlab:
  stage: push
  retry: 2
  only:
    - master
  before_script:
    - docker login -u $GITLAB_CI_USER -p $GITLAB_CI_TOKEN $GITLAB_CI_REGISTRY
  script:
    - docker push "${GITLAB_CI_REGISTRY}/focal:latest"
    - docker push "${GITLAB_CI_REGISTRY}/focal:supervisor"
    - docker push "${GITLAB_CI_REGISTRY}/focal:vscode"

## Clean up the build images
clean-latest:
  stage: clean
  only:
    - master
  before_script:
    - docker info
  script:
    - docker rmi "${CI_REGISTRY_IMAGE}/latest:supervisor" "${GITLAB_CI_REGISTRY}/latest:supervisor"
    - docker rmi "${CI_REGISTRY_IMAGE}/latest:vscode" "${GITLAB_CI_REGISTRY}/latest:vscode"
    - docker rmi "${CI_REGISTRY_IMAGE}:latest" "${GITLAB_CI_REGISTRY}:latest"
clean-eoan:
  stage: clean
  only:
    - master
  before_script:
    - docker info
  script:
    - docker rmi "${CI_REGISTRY_IMAGE}/eoan:supervisor" "${GITLAB_CI_REGISTRY}/eoan:supervisor"
    - docker rmi "${CI_REGISTRY_IMAGE}/eoan:vscode" "${GITLAB_CI_REGISTRY}/eoan:vscode"
    - docker rmi "${CI_REGISTRY_IMAGE}/eoan:latest" "${GITLAB_CI_REGISTRY}/eoan:latest"
clean-focal:
  stage: clean
  only:
    - master
  before_script:
    - docker info
  script:
    - docker rmi "${CI_REGISTRY_IMAGE}/focal:supervisor" "${GITLAB_CI_REGISTRY}/focal:supervisor"
    - docker rmi "${CI_REGISTRY_IMAGE}/focal:vscode" "${GITLAB_CI_REGISTRY}/focal:vscode"
    - docker rmi "${CI_REGISTRY_IMAGE}/focal:latest" "${GITLAB_CI_REGISTRY}/focal:latest"