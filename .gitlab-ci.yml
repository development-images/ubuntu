# Define stages
stages:
  - build-base
  - build

# Build base image
build-base:
  image: docker:latest
  stage: build-base
  services:
    - docker:dind
  rules:
    - changes:
      - base/**
  before_script:
    - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" "$CI_REGISTRY"
  variables:
    DOCKER_PATH: "./base/"
    IMAGE_TAG: "${CI_REGISTRY_IMAGE}/base"
  script:
    - docker build -t "${IMAGE_TAG}:${CI_COMMIT_SHORT_SHA}" "$DOCKER_PATH"
    - docker tag "${IMAGE_TAG}:${CI_COMMIT_SHORT_SHA}" "${IMAGE_TAG}:latest"
    - docker push "${IMAGE_TAG}:${CI_COMMIT_SHORT_SHA}"
    - docker push "${IMAGE_TAG}:latest"

# Build Python image
build-python:
  image: docker:latest
  stage: build
  services:
    - docker:dind
  rules:
    - changes:
      - base/**
      - python/**
  before_script:
    - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" "$CI_REGISTRY"
  variables:
    DOCKER_PATH: "./python/"
    IMAGE_TAG: "${CI_REGISTRY_IMAGE}/python"
  script:
    - docker build -t "${IMAGE_TAG}:${CI_COMMIT_SHORT_SHA}" "$DOCKER_PATH"
    - docker tag "${IMAGE_TAG}:${CI_COMMIT_SHORT_SHA}" "${IMAGE_TAG}:latest"
    - docker push "${IMAGE_TAG}:${CI_COMMIT_SHORT_SHA}"
    - docker push "${IMAGE_TAG}:latest"

# Build Ansible image
build-ansible:
  image: docker:latest
  stage: build
  services:
    - docker:dind
  rules:
    - changes:
      - base/**
      - ansible/**
  before_script:
    - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" "$CI_REGISTRY"
  variables:
    DOCKER_PATH: "./ansible/"
    IMAGE_TAG: "${CI_REGISTRY_IMAGE}/ansible"
  script:
    - docker build -t "${IMAGE_TAG}:${CI_COMMIT_SHORT_SHA}" "$DOCKER_PATH"
    - docker tag "${IMAGE_TAG}:${CI_COMMIT_SHORT_SHA}" "${IMAGE_TAG}:latest"
    - docker push "${IMAGE_TAG}:${CI_COMMIT_SHORT_SHA}"
    - docker push "${IMAGE_TAG}:latest"