---

stages:
  - build-base
  - push-base
  - build-vscode
  - push-vscode
  - build-vscode-lang
  - push-vscode-lang
  - clean

build-buster:
  stage: build-base
  retry: 2
  only:
    - production
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_JOB_TOKEN $CI_REGISTRY
  script:
    - docker build --pull -t $CI_REGISTRY_IMAGE:latest ./focal/
    - docker build --pull -t $GITLAB_CI_REGISTRY:latest ./focal/
    - docker build --pull -t $CI_REGISTRY_IMAGE/buster:minimal --target minimal ./buster/
    - docker build --pull -t $GITLAB_CI_REGISTRY/buster:minimal --target minimal ./buster/
    - docker build --pull -t $CI_REGISTRY_IMAGE/buster:latest --target full ./buster/
    - docker build --pull -t $GITLAB_CI_REGISTRY/buster:latest --target full ./buster/
    - docker build --pull -t $CI_REGISTRY_IMAGE/buster:supervisor --target supervisor ./buster/
    - docker build --pull -t $GITLAB_CI_REGISTRY/buster:supervisor --target supervisor ./buster/

build-bullseye:
  stage: build-base
  retry: 2
  only:
    - production
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_JOB_TOKEN $CI_REGISTRY
  script:
    - docker build --pull -t $CI_REGISTRY_IMAGE/bullseye:minimal --target minimal ./bullseye/
    - docker build --pull -t $GITLAB_CI_REGISTRY/bullseye:minimal --target minimal ./bullseye/
    - docker build --pull -t $CI_REGISTRY_IMAGE/bullseye:latest --target full ./bullseye/
    - docker build --pull -t $GITLAB_CI_REGISTRY/bullseye:latest --target full ./bullseye/
    - docker build --pull -t $CI_REGISTRY_IMAGE/bullseye:supervisor --target supervisor ./bullseye/
    - docker build --pull -t $GITLAB_CI_REGISTRY/bullseye:supervisor --target supervisor ./bullseye/

build-sid:
  stage: build-base
  retry: 2
  only:
    - production
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_JOB_TOKEN $CI_REGISTRY
  script:
    - docker build --pull -t $CI_REGISTRY_IMAGE/sid:minimal --target minimal ./sid/
    - docker build --pull -t $GITLAB_CI_REGISTRY/sid:minimal --target minimal ./sid/
    - docker build --pull -t $CI_REGISTRY_IMAGE/sid:latest --target full ./sid/
    - docker build --pull -t $GITLAB_CI_REGISTRY/sid:latest --target full ./sid/
    - docker build --pull -t $CI_REGISTRY_IMAGE/sid:supervisor --target supervisor ./sid/
    - docker build --pull -t $GITLAB_CI_REGISTRY/sid:supervisor --target supervisor ./sid/

build-stretch:
  stage: build-base
  retry: 2
  only:
    - production
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_JOB_TOKEN $CI_REGISTRY
  script:
    - docker build --pull -t $CI_REGISTRY_IMAGE/stretch:minimal --target minimal ./stretch/
    - docker build --pull -t $GITLAB_CI_REGISTRY/stretch:minimal --target minimal ./stretch/
    - docker build --pull -t $CI_REGISTRY_IMAGE/stretch:latest --target full ./stretch/
    - docker build --pull -t $GITLAB_CI_REGISTRY/stretch:latest --target full ./stretch/
    - docker build --pull -t $CI_REGISTRY_IMAGE/stretch:supervisor --target supervisor ./stretch/
    - docker build --pull -t $GITLAB_CI_REGISTRY/stretch:supervisor --target supervisor ./stretch/

build-vscode:
  stage: build-vscode
  retry: 2
  only:
    - production
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_JOB_TOKEN $CI_REGISTRY
  script:
    - docker build --pull -t $CI_REGISTRY_IMAGE/vscode:base --target base ./vscode/
    - docker build --pull -t $GITLAB_CI_REGISTRY/vscode:base --target base ./vscode/

build-vscode-full:
  stage: build-vscode-lang
  retry: 2
  only:
    - production
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_JOB_TOKEN $CI_REGISTRY
  script:
    - docker build --pull -t $CI_REGISTRY_IMAGE/vscode:latest --target full ./vscode/
    - docker build --pull -t $GITLAB_CI_REGISTRY/vscode:latest --target full ./vscode/

build-vscode-python:
  stage: build-vscode-lang
  retry: 2
  only:
    - production
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_JOB_TOKEN $CI_REGISTRY
  script:
    - docker build --pull -t $CI_REGISTRY_IMAGE/vscode/lang:python --target python ./vscode/
    - docker build --pull -t $GITLAB_CI_REGISTRY/vscode/lang:python --target python ./vscode/

build-vscode-perl:
  stage: build-vscode-lang
  retry: 2
  only:
    - production
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_JOB_TOKEN $CI_REGISTRY
  script:
    - docker build --pull -t $CI_REGISTRY_IMAGE/vscode/lang:perl --target perl ./vscode/
    - docker build --pull -t $GITLAB_CI_REGISTRY/vscode/lang:perl --target perl ./vscode/

build-vscode-php:
  stage: build-vscode-lang
  retry: 2
  only:
    - production
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_JOB_TOKEN $CI_REGISTRY
  script:
    - docker build --pull -t $CI_REGISTRY_IMAGE/vscode/lang:php --target php ./vscode/
    - docker build --pull -t $GITLAB_CI_REGISTRY/vscode/lang:php --target php ./vscode/

build-vscode-shell:
  stage: build-vscode-lang
  retry: 2
  only:
    - production
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_JOB_TOKEN $CI_REGISTRY
  script:
    - docker build --pull -t $CI_REGISTRY_IMAGE/vscode/lang:shell --target shell ./vscode/
    - docker build --pull -t $GITLAB_CI_REGISTRY/vscode/lang:shell --target shell ./vscode/

push-buster:
  stage: push-base
  retry: 2
  only:
    - production
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_JOB_TOKEN $CI_REGISTRY
    - docker login -u $GITLAB_CI_USER -p $GITLAB_CI_TOKEN $GITLAB_CI_REGISTRY
  script:
    - docker push $CI_REGISTRY_IMAGE:latest
    - docker push $GITLAB_CI_REGISTRY:latest
    - docker push $CI_REGISTRY_IMAGE/buster:minimal
    - docker push $GITLAB_CI_REGISTRY/buster:minimal
    - docker push $CI_REGISTRY_IMAGE/buster:latest
    - docker push $GITLAB_CI_REGISTRY/buster:latest

push-bullseye:
  stage: push-base
  retry: 2
  only:
    - production
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_JOB_TOKEN $CI_REGISTRY
    - docker login -u $GITLAB_CI_USER -p $GITLAB_CI_TOKEN $GITLAB_CI_REGISTRY
  script:
    - docker push $CI_REGISTRY_IMAGE/bullseye:minimal
    - docker push $GITLAB_CI_REGISTRY/bullseye:minimal
    - docker push $CI_REGISTRY_IMAGE/bullseye:latest
    - docker push $GITLAB_CI_REGISTRY/bullseye:latest
    - docker push $CI_REGISTRY_IMAGE/bullseye:supervisor
    - docker push $GITLAB_CI_REGISTRY/bullseye:supervisor

push-sid:
  stage: push-base
  retry: 2
  only:
    - production
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_JOB_TOKEN $CI_REGISTRY
    - docker login -u $GITLAB_CI_USER -p $GITLAB_CI_TOKEN $GITLAB_CI_REGISTRY
  script:
    - docker push $CI_REGISTRY_IMAGE/sid:minimal
    - docker push $GITLAB_CI_REGISTRY/sid:minimal
    - docker push $CI_REGISTRY_IMAGE/sid:latest
    - docker push $GITLAB_CI_REGISTRY/sid:latest
    - docker push $CI_REGISTRY_IMAGE/sid:supervisor
    - docker push $GITLAB_CI_REGISTRY/sid:supervisor

push-stretch:
  stage: push-base
  retry: 2
  only:
    - production
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_JOB_TOKEN $CI_REGISTRY
    - docker login -u $GITLAB_CI_USER -p $GITLAB_CI_TOKEN $GITLAB_CI_REGISTRY
  script:
    - docker push $CI_REGISTRY_IMAGE/stretch:minimal
    - docker push $GITLAB_CI_REGISTRY/stretch:minimal
    - docker push $CI_REGISTRY_IMAGE/stretch:latest
    - docker push $GITLAB_CI_REGISTRY/stretch:latest
    - docker push $CI_REGISTRY_IMAGE/stretch:supervisor
    - docker push $GITLAB_CI_REGISTRY/stretch:supervisor

push-vscode:
  stage: push-vscode
  retry: 2
  only:
    - production
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_JOB_TOKEN $CI_REGISTRY
    - docker login -u $GITLAB_CI_USER -p $GITLAB_CI_TOKEN $GITLAB_CI_REGISTRY
  script:
    - docker push $CI_REGISTRY_IMAGE/vscode:base
    - docker push $GITLAB_CI_REGISTRY/vscode:base

push-vscode-lang:
  stage: push-vscode-lang
  retry: 2
  only:
    - production
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_JOB_TOKEN $CI_REGISTRY
    - docker login -u $GITLAB_CI_USER -p $GITLAB_CI_TOKEN $GITLAB_CI_REGISTRY
  script:
    - docker push $CI_REGISTRY_IMAGE/vscode:latest
    - docker push $GITLAB_CI_REGISTRY/vscode:latest
    - docker push $CI_REGISTRY_IMAGE/vscode/lang:python
    - docker push $GITLAB_CI_REGISTRY/vscode/lang:python
    - docker push $CI_REGISTRY_IMAGE/vscode/lang:perl
    - docker push $GITLAB_CI_REGISTRY/vscode/lang:perl
    - docker push $CI_REGISTRY_IMAGE/vscode/lang:shell
    - docker push $GITLAB_CI_REGISTRY/vscode/lang:shell
    - docker push $CI_REGISTRY_IMAGE/vscode/lang:php
    - docker push $GITLAB_CI_REGISTRY/vscode/lang:php

clean:
  stage: clean
  retry: 2
  only:
    - production
  script:
    - docker image rm $CI_REGISTRY_IMAGE:latest
    - docker image rm $GITLAB_CI_REGISTRY:latest
    - docker image rm $CI_REGISTRY_IMAGE/buster:minimal
    - docker image rm $GITLAB_CI_REGISTRY/buster:minimal
    - docker image rm $CI_REGISTRY_IMAGE/buster:latest
    - docker image rm $GITLAB_CI_REGISTRY/buster:latest  
    - docker image rm $CI_REGISTRY_IMAGE/buster:supervisor
    - docker image rm $GITLAB_CI_REGISTRY/buster:supervisor
    - docker image rm $CI_REGISTRY_IMAGE/bullseye:minimal
    - docker image rm $GITLAB_CI_REGISTRY/bullseye:minimal
    - docker image rm $CI_REGISTRY_IMAGE/bullseye:latest
    - docker image rm $GITLAB_CI_REGISTRY/bullseye:latest
    - docker image rm $CI_REGISTRY_IMAGE/bullseye:supervisor
    - docker image rm $GITLAB_CI_REGISTRY/bullseye:supervisor
    - docker image rm $CI_REGISTRY_IMAGE/sid:minimal
    - docker image rm $GITLAB_CI_REGISTRY/sid:minimal
    - docker image rm $CI_REGISTRY_IMAGE/sid:latest
    - docker image rm $GITLAB_CI_REGISTRY/sid:latest
    - docker image rm $CI_REGISTRY_IMAGE/sid:supervisor
    - docker image rm $GITLAB_CI_REGISTRY/sid:supervisor
    - docker image rm $CI_REGISTRY_IMAGE/stretch:minimal
    - docker image rm $GITLAB_CI_REGISTRY/stretch:minimal
    - docker image rm $CI_REGISTRY_IMAGE/stretch:latest
    - docker image rm $GITLAB_CI_REGISTRY/stretch:latest
    - docker image rm $CI_REGISTRY_IMAGE/stretch:supervisor
    - docker image rm $GITLAB_CI_REGISTRY/stretch:supervisor
    - docker image rm $CI_REGISTRY_IMAGE/vscode:base
    - docker image rm $GITLAB_CI_REGISTRY/vscode:base
    - docker image rm $CI_REGISTRY_IMAGE/vscode:latest
    - docker image rm $GITLAB_CI_REGISTRY/vscode:latest
    - docker image rm $CI_REGISTRY_IMAGE/vscode/lang:python
    - docker image rm $GITLAB_CI_REGISTRY/vscode/lang:python
    - docker image rm $CI_REGISTRY_IMAGE/vscode/lang:perl
    - docker image rm $GITLAB_CI_REGISTRY/vscode/lang:perl
    - docker image rm $CI_REGISTRY_IMAGE/vscode/lang:shell
    - docker image rm $GITLAB_CI_REGISTRY/vscode/lang:shell
    - docker image rm $CI_REGISTRY_IMAGE/vscode/lang:php
    - docker image rm $GITLAB_CI_REGISTRY/vscode/lang:php