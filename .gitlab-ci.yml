---

# Set stages
stages:
  - build

# Common build setup for all containers
.build-common:
  stage: build
  image: docker:latest
  services:
    - docker:dind
  before_script:
    - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" "$CI_REGISTRY"
  script:
    - docker build -t "${IMAGE_TAG}/${RELEASE}:${CI_COMMIT_SHORT_SHA}" "$DOCKER_PATH"
    - docker tag "${IMAGE_TAG}/${RELEASE}:${CI_COMMIT_SHORT_SHA}" "${IMAGE_TAG}:latest"
    - docker push "${IMAGE_TAG}/${RELEASE}:${CI_COMMIT_SHORT_SHA}"
    - docker push "${IMAGE_TAG}/${RELEASE}:latest"

# Common build setup for base containers
.build-base:
  extends: .build-common
  variables:
    DOCKER_PATH: "./base/"
    IMAGE_TAG: "${CI_REGISTRY_IMAGE}/base"

# Build base container for Ubuntu Jammy
Build Base - Jammy:
  extends: .build-common
  variables:
    RELEASE: jammy

# Build base container for Ubuntu Kinetic
Build Base - Kinetic:
  extends: .build-common
  variables:
    RELEASE: kinetic

# Common build setup for Python containers
.build-python:
  extends: .build-common
  variables:
    DOCKER_PATH: "./python/"
    IMAGE_TAG: "${CI_REGISTRY_IMAGE}/python"

# Build Python container for Ubuntu Jammy
Build Python - Jammy:
  extends: .build-python
  needs:
    - Build Base - Jammy
  variables:
    RELEASE: jammy

# Build Python container for Ubuntu Kinetic
Build Python - Kinetic:
  extends: .build-python
  needs:
    - Build Base - Kinetic
  variables:
    RELEASE: kinetic

# Common build setup for Ansible containers
.build-ansible:
  extends: .build-common
  variables:
    DOCKER_PATH: "./ansible/"
    IMAGE_TAG: "${CI_REGISTRY_IMAGE}/ansible"

# Build Ansible container for Ubuntu Jammy
Build Ansible - Jammy:
  extends: .build-ansible
  needs:
    - Build Base - Jammy
  variables:
    RELEASE: jammy

# Build Ansible container for Ubuntu Kinetic
Build Ansible - Kinetic:
  extends: .build-ansible
  needs:
    - Build Base - Kinetic
  variables:
    RELEASE: kinetic

# Common build setup for Puppet containers
.build-puppet:
  extends: .build-common
  variables:
    DOCKER_PATH: "./puppet/"
    IMAGE_TAG: "${CI_REGISTRY_IMAGE}/puppet"

# Build Puppet container for Ubuntu Jammy
Build Puppet - Jammy:
  extends: .build-puppet
  needs:
    - Build Base - Jammy
  variables:
    RELEASE: jammy

# Common build setup for Django containers
.build-django:
  extends: .build-common
  variables:
    DOCKER_PATH: "./django/"
    IMAGE_TAG: "${CI_REGISTRY_IMAGE}/django"

# Build Django container for Ubuntu Jammy
Build Django - Jammy:
  extends: .build-django
  needs:
    - Build Python - Jammy
  variables:
    RELEASE: jammy

# Build Django container for Ubuntu Kinetic
Build Django - Kinetic:
  extends: .build-django
  needs:
    - Build Python - Kinetic
  variables:
    RELEASE: kinetic
