---

stages:
  - build-base
  - push-base
  - build-vscode
  - push-vscode
  - build-vscode-lang
  - push-vscode-lang

build-focal:
  stage: build-base
  only:
    - exec-ci
  before_script:
    - docker info
  script:
    - docker build -t $CI_REGISTRY_IMAGE:latest ./focal/
    - docker build -t $CI_REGISTRY_IMAGE/focal:minimal --target minimal ./focal/
    - docker build -t $CI_REGISTRY_IMAGE/focal:latest --target full ./focal/

build-eoan:
  stage: build-base
  only:
    - exec-ci
  before_script:
    - docker info
  script:
    - docker build -t $CI_REGISTRY_IMAGE/eoan:minimal --target minimal ./eoan/
    - docker build -t $CI_REGISTRY_IMAGE/eoan:latest --target full ./eoan/

build-vscode:
  stage: build-vscode
  only:
    - exec-ci
  before_script:
    - docker info
  script:
    - docker build -t $CI_REGISTRY_IMAGE/vscode:base --target base ./vscode/

build-vscode-full:
  stage: build-vscode-lang
  only:
    - exec-ci
  before_script:
    - docker info
  script:
    - docker build -t $CI_REGISTRY_IMAGE/vscode:latest --target full ./vscode/

build-vscode-python:
  stage: build-vscode-lang
  only:
    - exec-ci
  before_script:
    - docker info
  script:
    - docker build -t $CI_REGISTRY_IMAGE/vscode/lang:python --target python ./vscode/

build-vscode-perl:
  stage: build-vscode-lang
  only:
    - exec-ci
  before_script:
    - docker info
  script:
    - docker build -t $CI_REGISTRY_IMAGE/vscode/lang:perl --target perl ./vscode/

build-vscode-php:
  stage: build-vscode-lang
  only:
    - exec-ci
  before_script:
    - docker info
  script:
    - docker build -t $CI_REGISTRY_IMAGE/vscode/lang:php --target php ./vscode/

build-vscode-shell:
  stage: build-vscode-lang
  only:
    - exec-ci
  before_script:
    - docker info
  script:
    - docker build -t $CI_REGISTRY_IMAGE/vscode/lang:shell --target shell ./vscode/

push-focal:
  stage: push-base
  only:
    - exec-ci
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_JOB_TOKEN $CI_REGISTRY
  script:
    - docker push $CI_REGISTRY_IMAGE:latest
    - docker push $CI_REGISTRY_IMAGE/focal:minimal
    - docker push $CI_REGISTRY_IMAGE/focal:latest

push-eoan:
  stage: push-base
  only:
    - exec-ci
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_JOB_TOKEN $CI_REGISTRY
  script:
    - docker push $CI_REGISTRY_IMAGE/eoan:minimal
    - docker push $CI_REGISTRY_IMAGE/eoan:latest

push-vscode:
  stage: push-vscode
  only:
    - exec-ci
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_JOB_TOKEN $CI_REGISTRY
  script:
    - docker push $CI_REGISTRY_IMAGE/vscode:base

push-vscode-lang:
  stage: push-vscode-lang
  only:
    - exec-ci
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_JOB_TOKEN $CI_REGISTRY
  script:
    - docker push $CI_REGISTRY_IMAGE/vscode:latest
    - docker push $CI_REGISTRY_IMAGE/vscode/lang:python
    - docker push $CI_REGISTRY_IMAGE/vscode/lang:perl
    - docker push $CI_REGISTRY_IMAGE/vscode/lang:shell
    - docker push $CI_REGISTRY_IMAGE/vscode/lang:php